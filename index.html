<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Dashboard Vivero Inteligente</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Carga Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración para usar la fuente Inter y algunos colores -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-green': '#0faa2c',
                        'dark-green': '#055a12',
                        'light-green': '#e8ffe8',
                        'danger': '#dc2626',
                        'off-gray': '#4b5563',
                        'on-green': '#10b981',
                        'master-blue': '#1e40af',
                        'sun-yellow': '#f59e0b',
                        'valve-blue': '#3b82f6',
                        'temp-red': '#ef4444',
                        'hum-cyan': '#06b6d4',
                        'active-section': '#f59e0b',
                        'status-gray': '#9ca3af',
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #e8ffe8, #c3f7c3);
        }

        section {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        #login {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 50;
            background: linear-gradient(135deg, #e8ffe8, #c3f7c3);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .toggle-btn {
            transition: all 0.3s;
        }
        .toggle-btn:active {
            transform: scale(0.98);
        }
        
        .page-content {
            display: block;
        }

        /* NAVBAR STICKY MEJORADO PARA MÓVIL */
        #menu {
            position: sticky;
            top: 0;
            z-index: 40;
        }

        /* ESPACIADO PARA CONTENIDO PRINCIPAL */
        main {
            padding-top: 1rem;
            padding-bottom: 2rem;
        }

        /* Ajuste de altura mínima en móvil */
        @media (max-width: 768px) {
            main {
                padding-top: 0.5rem;
                min-height: auto;
            }
            
            /* Ajuste del nav en móvil */
            #menu .flex {
                gap: 0.5rem;
            }
            
            /* Botones del nav más compactos en móvil */
            #menu a, #menu button {
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
            }
        }

        /* -------------------- ESTILOS DE NOTIFICACIÓN (ALERTA BONITA) -------------------- */
        #notificationContainer {
            position: fixed;
            bottom: 20px;
            right: 20px;
            transform: translateX(150%);
            z-index: 1000;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.4s ease;
            opacity: 0;
            pointer-events: none;
            max-width: 90vw;
            width: 400px;
        }
        
        #notificationContainer.show {
            transform: translateX(0);
            opacity: 1;
            pointer-events: auto;
        }

        /* En móvil, ajustar posición */
        @media (max-width: 640px) {
            #notificationContainer {
                bottom: 20px;
                right: 10px;
                left: 10px;
                width: auto;
                max-width: none;
            }
        }

        /* -------------------- ESTILOS DE MODAL -------------------- */
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }

        /* Indicador de estado pulsante */
        .status-dot {
            height: 12px;
            width: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-dot.online {
            background-color: #10b981;
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            animation: pulse-green 2s infinite;
        }
        .status-dot.offline {
            background-color: #ef4444;
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            animation: none;
        }

        @keyframes pulse-green {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        /* Mejora de botón de notificaciones en móvil */
        #enableNotifyBtn {
            white-space: nowrap;
        }

        @media (max-width: 640px) {
            #enableNotifyBtn span.button-text {
                display: none;
            }
            #enableNotifyBtn {
                padding: 0.5rem;
                min-width: auto;
            }
        }
        
    </style>
</head>

<body class="font-sans text-gray-800">

<!-- -------------------- CONTENEDOR DE NOTIFICACIÓN -------------------- -->
<div id="notificationContainer" class="shadow-2xl rounded-lg p-4 flex items-center space-x-4 border-l-4 bg-white">
    <div id="notificationIcon" class="flex-shrink-0"></div>
    <div>
        <p id="notificationTitle" class="font-bold text-sm uppercase"></p>
        <p id="notificationMessage" class="text-sm text-gray-600"></p>
    </div>
</div>

<!-- -------------------- MODAL DE SECCIONES ACTIVAS -------------------- -->
<div id="activeSectionsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex justify-center items-center backdrop-blur-sm modal-overlay">
    <div class="bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-sm modal-content transform scale-95 opacity-0">
        <div class="flex justify-between items-center mb-4 border-b pb-2">
            <h3 class="text-xl font-bold text-dark-green">Ir a Sección Activa</h3>
            <button onclick="hideModal('activeSectionsModal')" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div id="activeSectionsList" class="space-y-3"></div>
        <p id="noActiveSectionsMessage" class="text-gray-500 text-center py-4 hidden">No hay válvulas de riego activas.</p>
    </div>
</div>

<!-- -------------------- MODAL DE CONFIRMACIÓN MAESTRA -------------------- -->
<div id="masterConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex justify-center items-center backdrop-blur-sm modal-overlay">
    <div class="bg-white p-8 rounded-xl shadow-2xl w-11/12 max-w-xs modal-content transform scale-95 opacity-0 text-center">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 mb-4">
            <svg class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
        </div>
        <h3 id="confirmTitle" class="text-xl font-bold mb-2 text-gray-900">Confirmar Acción</h3>
        <p id="confirmMessage" class="text-gray-500 mb-6">¿Estás seguro?</p>
        <div class="flex justify-around space-x-3">
            <button onclick="hideModal('masterConfirmModal')" class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold rounded-lg transition">Cancelar</button>
            <button id="confirmActionBtn" class="flex-1 px-4 py-2 bg-primary-green hover:bg-dark-green text-white font-bold rounded-lg transition shadow-lg">Confirmar</button>
        </div>
    </div>
</div>

<!-- -------------------- MODAL DE PROGRAMACIÓN DE RIEGO -------------------- -->
<div id="scheduleModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex justify-center items-center backdrop-blur-sm modal-overlay">
    <div class="bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-md modal-content transform scale-95 opacity-0">
        <div class="flex justify-between items-center mb-4 border-b pb-3">
            <h3 class="text-xl font-bold text-dark-green">Programar Riego</h3>
            <button onclick="hideModal('scheduleModal')" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        
        <div class="mb-4">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Sección:</label>
            <p id="scheduleSectionName" class="text-lg font-bold text-primary-green">Sección 1</p>
        </div>
        
        <div class="mb-4">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Frecuencia:</label>
            <div class="flex gap-3">
                <label class="flex-1 flex items-center justify-center p-3 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-primary-green transition">
                    <input type="radio" name="scheduleFrequency" value="once" class="mr-2" checked />
                    <span class="font-medium">Una vez</span>
                </label>
                <label class="flex-1 flex items-center justify-center p-3 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-primary-green transition">
                    <input type="radio" name="scheduleFrequency" value="daily" class="mr-2" />
                    <span class="font-medium">Todos los días</span>
                </label>
            </div>
        </div>
        
        <div class="mb-4">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Hora de Inicio:</label>
            <div class="flex gap-2">
                <input type="number" id="scheduleStartHour" min="1" max="12" placeholder="HH" class="w-20 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-green text-center" />
                <span class="flex items-center text-2xl font-bold">:</span>
                <input type="number" id="scheduleStartMin" min="0" max="59" placeholder="MM" class="w-20 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-green text-center" />
                <select id="scheduleStartPeriod" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-green font-semibold">
                    <option value="AM">AM</option>
                    <option value="PM">PM</option>
                </select>
            </div>
        </div>
        
        <div class="mb-4">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Hora de Fin:</label>
            <div class="flex gap-2">
                <input type="number" id="scheduleEndHour" min="1" max="12" placeholder="HH" class="w-20 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-green text-center" />
                <span class="flex items-center text-2xl font-bold">:</span>
                <input type="number" id="scheduleEndMin" min="0" max="59" placeholder="MM" class="w-20 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-green text-center" />
                <select id="scheduleEndPeriod" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-green font-semibold">
                    <option value="AM">AM</option>
                    <option value="PM">PM</option>
                </select>
            </div>
        </div>
        
        <div class="mb-6">
            <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                <span class="text-sm font-medium text-gray-700">Estado:</span>
                <span id="scheduleStatusText" class="text-sm font-bold text-gray-500">Sin programar</span>
            </div>
        </div>
        
        <div class="flex gap-3">
            <button id="cancelScheduleBtn" class="flex-1 px-4 py-2 bg-danger hover:bg-red-700 text-white font-semibold rounded-lg transition">
                Cancelar Programación
            </button>
            <button id="saveScheduleBtn" class="flex-1 px-4 py-2 bg-primary-green hover:bg-dark-green text-white font-bold rounded-lg transition shadow-lg">
                Guardar
            </button>
        </div>
    </div>
</div>

<!-- -------------------- MODAL DE CONFIRMACIÓN DE RIEGO PROGRAMADO -------------------- -->
<div id="scheduleConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex justify-center items-center backdrop-blur-sm modal-overlay">
    <div class="bg-white p-8 rounded-xl shadow-2xl w-11/12 max-w-sm modal-content transform scale-95 opacity-0 text-center">
        <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-blue-100 mb-4 animate-pulse">
            <svg class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        </div>
        <h3 class="text-2xl font-bold mb-3 text-gray-900">Riego Programado</h3>
        <p id="scheduleConfirmMessage" class="text-gray-600 mb-2 text-lg font-semibold">El riego se activará en 1 minuto</p>
        <p class="text-sm text-gray-500 mb-6">¿Deseas cancelar la activación?</p>
        <div id="countdownTimer" class="text-4xl font-bold text-primary-green mb-6">60s</div>
        <button id="cancelScheduledIrrigationBtn" class="w-full px-6 py-3 bg-danger hover:bg-red-700 text-white font-bold rounded-lg transition shadow-lg">
            Cancelar Activación
        </button>
    </div>
</div>

<!-- -------------------- MODAL DE CONFIGURACIÓN DE UMBRALES -------------------- -->
<div id="thresholdsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex justify-center items-center backdrop-blur-sm modal-overlay">
    <div class="bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-md modal-content transform scale-95 opacity-0">
        <div class="flex justify-between items-center mb-4 border-b pb-3">
            <h3 class="text-xl font-bold text-dark-green">Configurar Umbrales</h3>
            <button onclick="hideModal('thresholdsModal')" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        
        <div class="mb-4">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Sección:</label>
            <p id="thresholdSectionName" class="text-lg font-bold text-primary-green">Sección 1</p>
        </div>
        
        <div class="bg-blue-50 p-4 rounded-lg mb-4">
            <p class="text-xs text-gray-600 mb-2">
                <strong>Modo Automático:</strong> El riego se activará cuando la humedad del suelo esté por debajo del umbral mínimo y se detendrá al alcanzar el umbral máximo.
            </p>
        </div>
        
        <div class="mb-4">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Humedad Mínima (%):</label>
            <input type="number" id="thresholdMin" min="0" max="100" placeholder="Ej: 30" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-green" />
            <p class="text-xs text-gray-500 mt-1">Cuando la humedad baje de este valor, se activará el riego</p>
        </div>
        
        <div class="mb-6">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Humedad Máxima (%):</label>
            <input type="number" id="thresholdMax" min="0" max="100" placeholder="Ej: 70" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-green" />
            <p class="text-xs text-gray-500 mt-1">Cuando la humedad alcance este valor, se detendrá el riego</p>
        </div>
        
        <div class="flex gap-3">
            <button onclick="hideModal('thresholdsModal')" class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold rounded-lg transition">
                Cancelar
            </button>
            <button id="saveThresholdsBtn" class="flex-1 px-4 py-2 bg-primary-green hover:bg-dark-green text-white font-bold rounded-lg transition shadow-lg">
                Guardar
            </button>
        </div>
    </div>
</div>


<!-- -------------------- LOGIN -------------------- -->
<section id="login">
    <div id="loginForm" class="w-11/12 max-w-sm p-8 bg-white/90 backdrop-blur-sm rounded-xl shadow-2xl border border-primary-green/30">
        <h2 class="text-3xl font-extrabold mb-6 text-dark-green text-center">Acceso Dashboard</h2>
        <input type="email" id="email" placeholder="Correo Electrónico" required 
            class="w-full p-3 mb-4 text-gray-700 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-green transition duration-200" />
        <input type="password" id="password" placeholder="Contraseña" required 
            class="w-full p-3 mb-6 text-gray-700 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-green transition duration-200" />
        <button id="loginBtn" 
            class="w-full bg-primary-green hover:bg-dark-green text-white font-bold py-3 rounded-xl shadow-lg transition duration-300 transform hover:scale-[1.01]">
            Iniciar Sesión
        </button>
    </div>
</section>

<!-- -------------------- MENÚ DE NAVEGACIÓN -------------------- -->
<nav id="menu" class="hidden shadow-lg bg-white/95 backdrop-blur-md w-full">
    <div class="flex flex-col lg:flex-row justify-between items-center px-4 lg:px-6 py-3 lg:py-4">
        <div class="flex items-center space-x-3 mb-3 lg:mb-0">
            <svg class="w-7 h-7 lg:w-8 lg:h-8 text-primary-green" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.636a2 2 0 01-1.789-2.894l3.5-7A2 2 0 0114 10zM12 10V2"></path>
            </svg>
            <h1 class="text-lg lg:text-2xl font-bold text-dark-green whitespace-nowrap">Vivero Inteligente</h1>
        </div>
        <div class="flex flex-wrap justify-center items-center gap-2">
            <a href="#" onclick="showPage('dashboard')" id="nav-dashboard" class="px-3 py-2 rounded-lg font-medium transition-colors text-dark-green hover:bg-gray-100 text-sm">Dashboard</a>
            <a href="#" onclick="showPage('seccion1')" id="nav-seccion1" class="px-3 py-2 rounded-lg font-medium transition-colors text-dark-green hover:bg-gray-100 text-sm">Sección 1</a>
            <a href="#" onclick="showPage('seccion2')" id="nav-seccion2" class="px-3 py-2 rounded-lg font-medium transition-colors text-dark-green hover:bg-gray-100 text-sm">Sección 2</a>
            <a href="#" onclick="showPage('seccion3')" id="nav-seccion3" class="px-3 py-2 rounded-lg font-medium transition-colors text-dark-green hover:bg-gray-100 text-sm">Sección 3</a>
            
            <button id="enableNotifyBtn" class="hidden bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded-lg font-bold transition shadow flex items-center text-sm">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                <span class="ml-2 button-text">Alertas</span>
            </button>
            <button id="logoutBtnHeader" class="bg-gray-600 hover:bg-gray-800 text-white px-3 py-2 rounded-lg font-bold transition shadow text-sm">Salir</button>
        </div>
    </div>
</nav>

<!-- Contenedor principal -->
<main class="p-4 lg:p-8">

    <!-- -------------------- DASHBOARD -------------------- -->
    <section id="dashboard">
        <div class="page-content">
            <h2 class="text-2xl lg:text-4xl font-extrabold mb-6 lg:mb-8 text-dark-green text-center">
                Resumen del Sistema
            </h2>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4 lg:gap-6">
                
                <!-- 1. Tarjeta Estado Conexión (HEARTBEAT) -->
                <div id="systemStatusCard" class="p-4 lg:p-6 bg-white rounded-xl shadow-lg border-b-4 border-status-gray">
                    <h3 class="text-lg lg:text-xl font-bold mb-3 lg:mb-4 text-gray-600 flex items-center justify-center gap-2">
                        <div id="connectionDot" class="status-dot offline"></div>
                        Estado Sistema
                    </h3>
                    <p class="text-base lg:text-lg text-gray-700 mb-1 text-center font-bold" id="connectionStatusText">DESCONECTADO</p>
                    <p class="text-xs text-gray-500 text-center">Último latido: <span id="lastHeartbeatText">--</span></p>
                </div>

                <!-- 2. Tarjeta Modo Automático -->
                <div class="p-4 lg:p-6 bg-white rounded-xl shadow-lg border-b-4 border-primary-green">
                    <h3 class="text-lg lg:text-xl font-bold mb-3 lg:mb-4 text-dark-green flex items-center justify-center gap-2">
                        <svg class="w-5 h-5 lg:w-6 lg:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6a1 1 0 011-1h4a1 1 0 011 1v13m-4 0v-4h4v4m-8-12h8m-8 4h8"></path></svg>
                        Automático
                    </h3>
                    <p class="text-base lg:text-lg text-gray-600 mb-3 lg:mb-4 text-center">Estado: <span id="statusAuto" class="font-bold">...</span></p>
                    <button id="btnAuto" class="toggle-btn w-full text-white font-bold py-2 rounded-lg shadow-md text-xs lg:text-sm">
                        Activar/Desactivar
                    </button>
                </div>

                 <!-- 3. Tarjeta Motobomba -->
                <div class="p-4 lg:p-6 bg-white rounded-xl shadow-lg border-b-4 border-master-blue">
                    <h3 class="text-lg lg:text-xl font-bold mb-3 lg:mb-4 text-master-blue flex items-center justify-center gap-2">
                        <svg class="w-5 h-5 lg:w-6 lg:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        Motobomba
                    </h3>
                    <p class="text-base lg:text-lg text-gray-600 mb-1 text-center">Estado: <span id="status4" class="font-bold text-red-500">OFF</span></p>
                    <p class="text-xs text-gray-500 text-center">Automático (según válvulas)</p>
                </div>

                <!-- 4. Tarjeta Temperatura -->
                <div class="p-4 lg:p-6 bg-white rounded-xl shadow-lg border-b-4 border-temp-red">
                    <h3 class="text-lg lg:text-xl font-bold mb-3 lg:mb-4 text-temp-red flex items-center justify-center gap-2">
                        <svg class="w-5 h-5 lg:w-6 lg:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        Temperatura
                    </h3>
                    <p class="text-3xl lg:text-4xl font-extrabold text-gray-700 mb-2 text-center"><span id="val-temperatura">--</span></p>
                </div>

                <!-- 5. Tarjeta Humedad Ambiente -->
                <div class="p-4 lg:p-6 bg-white rounded-xl shadow-lg border-b-4 border-hum-cyan">
                    <h3 class="text-lg lg:text-xl font-bold mb-3 lg:mb-4 text-hum-cyan flex items-center justify-center gap-2">
                        <svg class="w-5 h-5 lg:w-6 lg:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path></svg>
                        Humedad Amb.
                    </h3>
                    <p class="text-3xl lg:text-4xl font-extrabold text-gray-700 mb-2 text-center"><span id="val-humedad-ambiente">--</span></p>
                </div>

                <!-- 6. Tarjeta Secciones Activas -->
                <div id="activeSectionsCard" class="p-4 lg:p-6 bg-white rounded-xl shadow-lg border-b-4 border-gray-400 transition duration-300 transform hover:shadow-xl cursor-pointer hover:scale-105">
                    <h3 class="text-lg lg:text-xl font-bold mb-3 lg:mb-4 text-gray-700 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5 lg:w-6 lg:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                        Activas
                    </h3>
                    <p class="text-3xl lg:text-4xl font-extrabold text-gray-700 mb-2 text-center"><span id="val-active-sections">0</span></p>
                    <p class="text-xs text-gray-500 text-center"><span id="activeSectionsHint">Ninguna</span></p>
                </div>
            </div>

            <!-- Botón Master -->
            <div class="max-w-xl mx-auto mt-8 lg:mt-12 p-4 lg:p-6 bg-white/60 rounded-xl shadow-sm text-center">
                <p class="text-gray-700 font-semibold mb-3">Control General</p>
                <button id="masterToggleBtn" class="toggle-btn w-full bg-danger hover:bg-red-700 text-white font-bold py-3 lg:py-4 rounded-xl shadow-lg text-base lg:text-lg">
                    Cargando...
                </button>
            </div>
        </div>
    </section>

    <!-- -------------------- SECCIÓN 1 -------------------- -->
    <section id="seccion1">
        <div class="page-content">
            <h2 class="text-2xl lg:text-4xl font-extrabold mb-6 lg:mb-8 text-dark-green text-center">
                Sección 1: Semisombra
            </h2>
            
            <div class="flex flex-wrap justify-center gap-4 lg:gap-6">
                <div class="w-full max-w-sm p-4 lg:p-6 bg-white rounded-xl shadow-lg border-b-4 border-valve-blue">
                    <h3 class="text-lg lg:text-xl font-bold mb-3 lg:mb-4 text-blue-700 text-center">ElectroVálvula 1</h3>
                    <p class="text-base lg:text-lg text-gray-600 mb-3 lg:mb-4 text-center">Estado: <span id="status1" class="font-bold">...</span></p>
                    <button id="btn1" class="toggle-btn w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 lg:py-3 rounded-lg shadow text-sm lg:text-base mb-2">
                        Control Manual
                    </button>
                    <button onclick="openScheduleModal(1)" class="w-full bg-sun-yellow hover:bg-yellow-600 text-white font-bold py-2 rounded-lg shadow text-sm lg:text-base flex items-center justify-center gap-2 mb-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Programar Riego
                    </button>
                    <button onclick="openThresholdsModal(1)" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 rounded-lg shadow text-sm lg:text-base flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                        Umbrales Auto
                    </button>
                    <div id="schedule-info-1" class="mt-2 text-xs text-center text-gray-500 hidden">
                        <span class="font-semibold">Programado:</span> <span id="schedule-time-1">--</span>
                    </div>
                    <div id="threshold-info-1" class="mt-2 text-xs text-center text-gray-600 bg-purple-50 p-2 rounded hidden">
                        <span class="font-semibold">Auto:</span> <span id="threshold-values-1">--</span>
                    </div>
                </div>
                <div class="w-full max-w-sm p-4 lg:p-6 bg-white rounded-xl shadow-lg border-b-4 border-blue-400">
                    <h3 class="text-lg lg:text-xl font-bold mb-2 text-blue-600 text-center">Humedad Suelo</h3>
                    <p class="text-4xl lg:text-5xl font-extrabold text-center text-blue-500 my-3 lg:my-4"><span class="humedad-value-1">--</span></p>
                </div>
                <div class="w-full max-w-sm p-4 lg:p-6 bg-white rounded-xl shadow-lg border-b-4 border-sun-yellow">
                    <h3 class="text-lg lg:text-xl font-bold mb-2 text-sun-yellow text-center">Luminosidad</h3>
                    <p class="text-4xl lg:text-5xl font-extrabold text-center text-yellow-500 my-3 lg:my-4"><span class="luminosity-value-1">--</span></p>
                </div>
            </div>
        </div>
    </section>

    <!-- -------------------- SECCIÓN 2 -------------------- -->
    <section id="seccion2">
        <div class="page-content">
            <h2 class="text-2xl lg:text-4xl font-extrabold mb-6 lg:mb-8 text-dark-green text-center">
                Sección 2: Sol
            </h2>
            <div class="flex flex-wrap justify-center gap-4 lg:gap-6">
                <div class="w-full max-w-sm p-4 lg:p-6 bg-white rounded-xl shadow-lg border-b-4 border-valve-blue">
                    <h3 class="text-lg lg:text-xl font-bold mb-3 lg:mb-4 text-blue-700 text-center">ElectroVálvula 2</h3>
                    <p class="text-base lg:text-lg text-gray-600 mb-3 lg:mb-4 text-center">Estado: <span id="status2" class="font-bold">...</span></p>
                    <button id="btn2" class="toggle-btn w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 lg:py-3 rounded-lg shadow text-sm lg:text-base mb-2">
                        Control Manual
                    </button>
                    <button onclick="openScheduleModal(2)" class="w-full bg-sun-yellow hover:bg-yellow-600 text-white font-bold py-2 rounded-lg shadow text-sm lg:text-base flex items-center justify-center gap-2 mb-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Programar Riego
                    </button>
                    <button onclick="openThresholdsModal(2)" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 rounded-lg shadow text-sm lg:text-base flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                        Umbrales Auto
                    </button>
                    <div id="schedule-info-2" class="mt-2 text-xs text-center text-gray-500 hidden">
                        <span class="font-semibold">Programado:</span> <span id="schedule-time-2">--</span>
                    </div>
                    <div id="threshold-info-2" class="mt-2 text-xs text-center text-gray-600 bg-purple-50 p-2 rounded hidden">
                        <span class="font-semibold">Auto:</span> <span id="threshold-values-2">--</span>
                    </div>
                </div>
                <div class="w-full max-w-sm p-4 lg:p-6 bg-white rounded-xl shadow-lg border-b-4 border-blue-400">
                    <h3 class="text-lg lg:text-xl font-bold mb-2 text-blue-600 text-center">Humedad Suelo</h3>
                    <p class="text-4xl lg:text-5xl font-extrabold text-center text-blue-500 my-3 lg:my-4"><span class="humedad-value-2">--</span></p>
                </div>
                <div class="w-full max-w-sm p-4 lg:p-6 bg-white rounded-xl shadow-lg border-b-4 border-sun-yellow">
                    <h3 class="text-lg lg:text-xl font-bold mb-2 text-sun-yellow text-center">Luminosidad</h3>
                    <p class="text-4xl lg:text-5xl font-extrabold text-center text-yellow-500 my-3 lg:my-4"><span class="luminosity-value-2">--</span></p>
                </div>
            </div>
        </div>
    </section>

    <!-- -------------------- SECCIÓN 3 -------------------- -->
    <section id="seccion3">
        <div class="page-content">
            <h2 class="text-2xl lg:text-4xl font-extrabold mb-6 lg:mb-8 text-dark-green text-center">
                Sección 3: Sombra
            </h2>
            <div class="flex flex-wrap justify-center gap-4 lg:gap-6">
                <div class="w-full max-w-sm p-4 lg:p-6 bg-white rounded-xl shadow-lg border-b-4 border-valve-blue">
                    <h3 class="text-lg lg:text-xl font-bold mb-3 lg:mb-4 text-blue-700 text-center">ElectroVálvula 3</h3>
                    <p class="text-base lg:text-lg text-gray-600 mb-3 lg:mb-4 text-center">Estado: <span id="status3" class="font-bold">...</span></p>
                    <button id="btn3" class="toggle-btn w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 lg:py-3 rounded-lg shadow text-sm lg:text-base mb-2">
                        Control Manual
                    </button>
                    <button onclick="openScheduleModal(3)" class="w-full bg-sun-yellow hover:bg-yellow-600 text-white font-bold py-2 rounded-lg shadow text-sm lg:text-base flex items-center justify-center gap-2 mb-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Programar Riego
                    </button>
                    <button onclick="openThresholdsModal(3)" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 rounded-lg shadow text-sm lg:text-base flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                        Umbrales Auto
                    </button>
                    <div id="schedule-info-3" class="mt-2 text-xs text-center text-gray-500 hidden">
                        <span class="font-semibold">Programado:</span> <span id="schedule-time-3">--</span>
                    </div>
                    <div id="threshold-info-3" class="mt-2 text-xs text-center text-gray-600 bg-purple-50 p-2 rounded hidden">
                        <span class="font-semibold">Auto:</span> <span id="threshold-values-3">--</span>
                    </div>
                </div>
                <div class="w-full max-w-sm p-4 lg:p-6 bg-white rounded-xl shadow-lg border-b-4 border-blue-400">
                    <h3 class="text-lg lg:text-xl font-bold mb-2 text-blue-600 text-center">Humedad Suelo</h3>
                    <p class="text-4xl lg:text-5xl font-extrabold text-center text-blue-500 my-3 lg:my-4"><span class="humedad-value-3">--</span></p>
                </div>
                <div class="w-full max-w-sm p-4 lg:p-6 bg-white rounded-xl shadow-lg border-b-4 border-sun-yellow">
                    <h3 class="text-lg lg:text-xl font-bold mb-2 text-sun-yellow text-center">Luminosidad</h3>
                    <p class="text-4xl lg:text-5xl font-extrabold text-center text-yellow-500 my-3 lg:my-4"><span class="luminosity-value-3">--</span></p>
                </div>
            </div>
        </div>
    </section>

</main>

<footer class="text-center py-4 lg:py-6 text-gray-600 text-xs lg:text-sm mt-8 lg:mt-12 border-t border-gray-300 bg-white/50">
    Vivero Inteligente &copy; 2024
</footer>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getDatabase, ref, onValue, get, set } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, signOut, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}'); 
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    
    const fallbackConfig = {
        apiKey: "AIzaSyCftCgLDkk8EG3pswtPOA33buAlI_cPmYI",
        authDomain: "vivero-90782.firebaseapp.com",
        databaseURL: "https://vivero-90782-default-rtdb.firebaseio.com",
        projectId: "vivero-90782",
    };
    
    let app, db, auth;
    try {
        app = initializeApp(firebaseConfig.apiKey ? firebaseConfig : fallbackConfig);
        auth = getAuth(app);
        db = getDatabase(app);
    } catch(e) {
        console.error("Init error", e);
    }

  
    const RELAYS = [
        { id: 1, path: "relay1", name: "ElectroVálvula 1", section: "seccion1", friendlyName: "Sección 1 (Semisombra)", sectionKey: "semisombra" },
        { id: 2, path: "relay2", name: "ElectroVálvula 2", section: "seccion2", friendlyName: "Sección 2 (Sol)", sectionKey: "sol" },
        { id: 3, path: "relay3", name: "ElectroVálvula 3", section: "seccion3", friendlyName: "Sección 3 (Sombra)", sectionKey: "sombra" },
        { id: 4, path: "relay4", name: "Motobomba", isMaster: true }
    ];
    const relayStates = { relay1: false, relay2: false, relay3: false, relay4: false };
    const alertCooldowns = {};
    
    // --- Variables para programación de riego ---
    const schedules = { 1: null, 2: null, 3: null };
    let currentScheduleSection = null;
    let scheduleCheckInterval = null;
    let countdownInterval = null;
    
    // --- Variables para umbrales ---
    const thresholds = { 1: null, 2: null, 3: null };
    let currentThresholdSection = null;

    // --- Variables para Heartbeat ---
    let lastHeartbeatTime = 0;
    const SYSTEM_OFFLINE_TIMEOUT = 60000;
    let heartbeatInterval;

    // --- UI Logic ---
    function showPage(pageId) {
        document.querySelectorAll("section").forEach(s => s.style.display = "none");
        const target = document.getElementById(pageId);
        if (target) {
            target.style.display = (pageId === 'login' ? 'flex' : 'block');
        }
        document.querySelectorAll('#menu a').forEach(a => {
            a.classList.remove('bg-primary-green', 'text-white');
            a.classList.add('text-dark-green');
        });
        const currentNav = document.getElementById(`nav-${pageId}`);
        if (currentNav) {
            currentNav.classList.add('bg-primary-green', 'text-white');
            currentNav.classList.remove('text-dark-green');
        }
    }
    window.showPage = showPage;

    // --- SISTEMA DE NOTIFICACIONES ---
    let notificationTimeout;
    function displayMessage(msg, type = 'info') {
        const container = document.getElementById('notificationContainer');
        const titleEl = document.getElementById('notificationTitle');
        const messageEl = document.getElementById('notificationMessage');
        const iconEl = document.getElementById('notificationIcon');

        clearTimeout(notificationTimeout);
        container.className = 'shadow-2xl rounded-lg p-4 flex items-center space-x-4 border-l-4 bg-white transform transition-all duration-500';
        let borderColorClass, iconSvg, titleText;

        if (type === 'success' || type === 'confirm') {
            borderColorClass = 'border-primary-green'; titleText = "¡Éxito!";
            iconSvg = `<div class="bg-green-100 p-2 rounded-full"><svg class="w-6 h-6 text-primary-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div>`;
        } else if (type === 'error' || type === 'danger') {
            borderColorClass = 'border-danger'; titleText = "Alerta";
            iconSvg = `<div class="bg-red-100 p-2 rounded-full"><svg class="w-6 h-6 text-danger" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /> </svg></div>`;
        } else {
            borderColorClass = 'border-blue-500'; titleText = "Información";
            iconSvg = `<div class="bg-blue-100 p-2 rounded-full"><svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>`;
        }

        container.classList.add(borderColorClass);
        titleEl.innerText = titleText;
        titleEl.className = `font-bold text-sm uppercase ${type === 'error' ? 'text-danger' : (type === 'success' ? 'text-primary-green' : 'text-blue-600')}`;
        messageEl.innerText = msg;
        iconEl.innerHTML = iconSvg;

        requestAnimationFrame(() => { container.classList.add('show'); });
        notificationTimeout = setTimeout(() => { container.classList.remove('show'); }, 4500);
    }

    function checkAndAlert(key, msg, type, alertTitle = "Alerta del Vivero") {
        const now = Date.now();
        if (!alertCooldowns[key] || (now - alertCooldowns[key] > 60000)) {
            displayMessage(msg, type);
            if (type === 'error' && "Notification" in window && Notification.permission === "granted") {
                 const iconUrl = 'https://cdn-icons-png.flaticon.com/512/564/564619.png'; 
                 new Notification(alertTitle, { body: msg, icon: iconUrl, vibrate: [200, 100, 200], tag: key });
            }
            alertCooldowns[key] = now;
        }
    }

    function showModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('hidden');
            const modalContent = modal.querySelector('.modal-content');
            if (modalContent) {
                setTimeout(() => {
                    modalContent.classList.remove('scale-95', 'opacity-0');
                    modalContent.classList.add('scale-100', 'opacity-100');
                }, 10);
            }
        }
    }
    function hideModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            const modalContent = modal.querySelector('.modal-content');
            if (modalContent) {
                modalContent.classList.remove('scale-100', 'opacity-100');
                modalContent.classList.add('scale-95', 'opacity-0');
            }
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }
    }
    window.hideModal = hideModal;
    window.showModal = showModal;

    const loginBtn = document.getElementById("loginBtn");
    loginBtn.addEventListener("click", () => {
        const email = document.getElementById("email").value;
        const pass = document.getElementById("password").value;

        signInWithEmailAndPassword(auth, email, pass)
            .then(() => {
                displayMessage("Inicio de sesión exitoso.", "success");
            })
            .catch((err) => {
                displayMessage("Correo o contraseña incorrectos.", "error");
                console.error(err);
            });
    });

    const enableNotifyBtn = document.getElementById('enableNotifyBtn');
    if (enableNotifyBtn) {
        enableNotifyBtn.addEventListener('click', () => {
            if (!("Notification" in window)) { 
                displayMessage("Tu navegador no soporta notificaciones.", "error"); 
                return; 
            }
            
            Notification.requestPermission().then(permission => {
                console.log('Permiso resultado:', permission);
                if (permission === "granted") {
                    displayMessage("¡Notificaciones activadas!", "success");
                    enableNotifyBtn.classList.add('hidden');
                    try {
                        new Notification("Vivero Inteligente", { 
                            body: "Sistema de alertas activo.",
                            icon: 'https://cdn-icons-png.flaticon.com/512/3050/3050158.png'
                        });
                    } catch(e) {
                        console.log('Error al crear notificación:', e);
                    }
                } else { 
                    displayMessage("Permiso denegado. Ve a configuración del navegador para habilitarlas.", "error"); 
                }
            }).catch(err => {
                console.log('Error al solicitar permiso:', err);
                displayMessage("Error al solicitar permisos de notificación", "error");
            });
        });
    }
    const logoutBtn = document.getElementById("logoutBtnHeader");
    if(logoutBtn) {
        logoutBtn.addEventListener("click", () => {
            signOut(auth).then(() => { displayMessage("Sesión cerrada.", 'info'); });
        });
    }

    onAuthStateChanged(auth, (user) => {
        const menu = document.getElementById("menu");
        const loginSection = document.getElementById("login");
        if (user) {
            loginSection.style.display = 'none';
            menu.classList.remove('hidden');
            showPage('dashboard');
            startRelayControl();
            startHeartbeatMonitoring();
            startScheduleMonitoring();
            loadSchedulesFromFirebase();
            loadThresholdsFromFirebase();
            
            // Esperar un momento para que el DOM esté completamente cargado
            setTimeout(() => {
                initializeThresholdsButton();
                console.log('Botones inicializados después del login');
            }, 500);
            
            checkNotificationButtonVisibility();
        } else {
            menu.classList.add('hidden');
            showPage('login');
            clearInterval(heartbeatInterval);
            clearInterval(scheduleCheckInterval);
        }
    });

    // Función para verificar y mostrar botón de notificaciones
    function checkNotificationButtonVisibility() {
        const enableNotifyBtn = document.getElementById('enableNotifyBtn');
        
        console.log('Verificando notificaciones...');
        console.log('Notification support:', "Notification" in window);
        
        if (!enableNotifyBtn) {
            console.log('Botón no encontrado');
            return;
        }
        
        if (!("Notification" in window)) {
            console.log('Navegador no soporta notificaciones');
            enableNotifyBtn.classList.add('hidden');
            return;
        }
        
        console.log('Notification.permission:', Notification.permission);
        
        if (Notification.permission === "default") {
            // Permiso no solicitado - MOSTRAR botón
            console.log('Mostrando botón de notificaciones');
            enableNotifyBtn.classList.remove('hidden');
            enableNotifyBtn.style.display = 'flex';
        } else if (Notification.permission === "granted") {
            // Ya concedido - ocultar
            console.log('Notificaciones ya concedidas, ocultando botón');
            enableNotifyBtn.classList.add('hidden');
        } else {
            // Denegado - ocultar
            console.log('Notificaciones denegadas, ocultando botón');
            enableNotifyBtn.classList.add('hidden');
        }
    }

    // --- Heartbeat Logic ---
    function startHeartbeatMonitoring() {
        const heartbeatRef = ref(db, "/last_heartbeat");
        const statusCard = document.getElementById("systemStatusCard");
        const statusDot = document.getElementById("connectionDot");
        const statusText = document.getElementById("connectionStatusText");
        const lastHeartbeatText = document.getElementById("lastHeartbeatText");

        onValue(heartbeatRef, (snap) => {
            lastHeartbeatTime = snap.val() || 0;
            updateHeartbeatUI(Date.now());
        });

        // Revisar cada 5 segundos si estamos desfasados
        heartbeatInterval = setInterval(() => {
            updateHeartbeatUI(Date.now());
        }, 5000);

        function updateHeartbeatUI(now) {
            const diff = now - lastHeartbeatTime;
            const isOnline = diff < SYSTEM_OFFLINE_TIMEOUT && lastHeartbeatTime > 0;

            // Actualizar tarjeta visualmente
            if (statusCard) {
                statusCard.className = `p-4 lg:p-6 bg-white rounded-xl shadow-lg border-b-4 ${isOnline ? 'border-on-green' : 'border-status-gray'}`;
            }
            if (statusDot) {
                statusDot.className = `status-dot ${isOnline ? 'online' : 'offline'}`;
            }
            if (statusText) {
                statusText.innerText = isOnline ? "EN LÍNEA" : "DESCONECTADO";
                statusText.className = `text-base lg:text-lg font-bold text-center ${isOnline ? 'text-green-600' : 'text-gray-500'}`;
            }
            if (lastHeartbeatText) {
                // Mostrar en hora de Colombia
                const heartbeatDate = new Date(lastHeartbeatTime);
                const colombiaTimeStr = heartbeatDate.toLocaleTimeString('es-CO', {
                    timeZone: 'America/Bogota',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                lastHeartbeatText.innerText = lastHeartbeatTime > 0 ? colombiaTimeStr : "Nunca";
            }
            
            // Alerta de desconexión
            if (!isOnline && lastHeartbeatTime > 0) {
                checkAndAlert('system_offline', '¡ALERTA! El sistema parece estar desconectado.', 'error', 'CONEXIÓN PERDIDA');
            }
        }
    }


    // --- Logic ---
    let activeRelaysData = []; 
    function populateActiveSectionsModal(activeSections) {
        const listEl = document.getElementById('activeSectionsList');
        const noMessageEl = document.getElementById('noActiveSectionsMessage');
        listEl.innerHTML = ''; 
        if (activeSections.length === 0) { noMessageEl.classList.remove('hidden'); } else {
            noMessageEl.classList.add('hidden');
            activeSections.forEach(section => {
                const button = document.createElement('button');
                button.className = 'w-full text-left p-3 rounded-lg bg-light-green hover:bg-primary-green hover:text-white transition duration-200 font-semibold text-dark-green flex justify-between items-center shadow-sm';
                button.innerHTML = `<span>${section.friendlyName}</span><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>`;
                button.onclick = () => { hideModal('activeSectionsModal'); showPage(section.section); };
                listEl.appendChild(button);
            });
        }
        showModal('activeSectionsModal');
    }

    function startRelayControl() {
        const autoRef = ref(db, "/modoAutomatico");
        const statusAutoEl = document.getElementById("statusAuto");
        const btnAuto = document.getElementById("btnAuto");
        const masterBtn = document.getElementById("masterToggleBtn");
        const confirmActionBtn = document.getElementById("confirmActionBtn");
        const confirmTitle = document.getElementById("confirmTitle");
        const confirmMessage = document.getElementById("confirmMessage");
        
        const tempRef = ref(db, "/temperatura");
        const humAmbRef = ref(db, "/humedadAmbiente");
        const tempEl = document.getElementById("val-temperatura");
        const humAmbEl = document.getElementById("val-humedad-ambiente");
        const activeSectionsCard = document.getElementById("activeSectionsCard");
        const activeSectionsCountEl = document.getElementById("val-active-sections");
        const activeSectionsHintEl = document.getElementById("activeSectionsHint");

        onValue(tempRef, (snap) => {
            const val = snap.val();
            if(tempEl) tempEl.innerText = val !== null ? val + " °C" : "--";
            if (val !== null) {
                if (val > 35) checkAndAlert('high_temp', `¡Atención! Alta Temperatura detectada: ${val}°C`, 'error', '¡CALOR EXCESIVO!');
                else if (val < 15) checkAndAlert('low_temp', `¡Atención! Baja Temperatura detectada: ${val}°C`, 'error', '¡FRÍO CRÍTICO!');
            }
        });
        onValue(humAmbRef, (snap) => {
            const val = snap.val();
            if(humAmbEl) humAmbEl.innerText = val !== null ? val + " %" : "--";
            if (val !== null) {
                if (val < 30) checkAndAlert('low_hum_amb', `Humedad Ambiente muy baja: ${val}%`, 'error', '¡AIRE MUY SECO!');
                else if (val > 90) checkAndAlert('high_hum_amb', `Humedad Ambiente crítica: ${val}%`, 'error', '¡HUMEDAD EXCESIVA!');
            }
        });

        setupSensorListener('semisombra', 1);
        setupSensorListener('sol', 2);
        setupSensorListener('sombra', 3);

        onValue(autoRef, (snap) => {
            const val = snap.val();
            if(statusAutoEl) {
                statusAutoEl.innerText = val ? "ACTIVADO" : "DESACTIVADO";
                statusAutoEl.className = val ? "font-bold text-primary-green" : "font-bold text-red-500";
            }
            if(btnAuto) {
                btnAuto.className = `toggle-btn w-full text-white font-bold py-2 rounded-lg shadow-md text-xs lg:text-sm ${val ? 'bg-red-500 hover:bg-red-600' : 'bg-primary-green hover:bg-green-700'}`;
                btnAuto.innerText = val ? "DESACTIVAR MODO AUTO" : "ACTIVAR MODO AUTO";
            }
            if(masterBtn) {
                masterBtn.disabled = val;
                if(val) masterBtn.classList.add('opacity-50', 'cursor-not-allowed');
                else masterBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });

        if(btnAuto) {
            btnAuto.onclick = async () => {
                const s = await get(autoRef);
                const target = !s.val();
                set(autoRef, target).then(() => displayMessage(`Modo Automático ${target ? 'Activado' : 'Desactivado'}`, 'success'));
            }
        }
        
        function updateActiveSectionsUI() {
            activeRelaysData = RELAYS.slice(0, 3).filter(r => relayStates[r.path]);
            const activeCount = activeRelaysData.length;
            const cardTitleEl = activeSectionsCard ? activeSectionsCard.querySelector('h3') : null;
            if (activeSectionsCountEl) activeSectionsCountEl.innerText = activeCount;
            if (activeSectionsCard) {
                activeSectionsCard.classList.remove('border-gray-400', 'border-primary-green', 'bg-light-green', 'cursor-pointer');
                if (cardTitleEl) cardTitleEl.classList.remove('text-primary-green', 'text-gray-700');
                if (activeCount > 0) {
                    activeSectionsCard.classList.add('border-primary-green', 'bg-light-green', 'cursor-pointer', 'hover:bg-primary-green/20');
                    if (cardTitleEl) cardTitleEl.classList.add('text-primary-green');
                    if (activeSectionsHintEl) activeSectionsHintEl.innerText = "¡Toca para ver detalles!";
                } else {
                    activeSectionsCard.classList.add('border-gray-400', 'bg-white');
                    if (cardTitleEl) cardTitleEl.classList.add('text-gray-700');
                    if (activeSectionsHintEl) activeSectionsHintEl.innerText = "Ninguna activa";
                }
            }
        }

        if (activeSectionsCard) {
            activeSectionsCard.onclick = () => {
                if (activeRelaysData.length > 0) { populateActiveSectionsModal(activeRelaysData); } else { displayMessage("No hay válvulas activas en este momento.", 'info'); }
            };
        }

        RELAYS.forEach(r => {
            const rRef = ref(db, "/" + r.path);
            const statEl = document.getElementById(`status${r.id}`);
            const btnEl = document.getElementById(`btn${r.id}`);
            onValue(rRef, (snap) => {
                const val = snap.val();
                relayStates[r.path] = val;
                if(statEl) {
                    statEl.innerText = val ? "ENCENDIDO" : "APAGADO";
                    statEl.className = val ? "font-bold text-primary-green" : "font-bold text-red-500";
                }
                if(btnEl && !r.isMaster) {
                    btnEl.className = `toggle-btn w-full text-white font-bold py-2 lg:py-3 rounded-lg shadow text-sm lg:text-base ${val ? 'bg-green-500 hover:bg-green-600' : 'bg-blue-500 hover:bg-blue-600'}`;
                    btnEl.innerText = val ? "CERRAR VÁLVULA" : "ABRIR VÁLVULA";
                }
                if(!r.isMaster) { updateRelay4MasterState(); updateActiveSectionsUI(); }
                if(r.id === 1 || r.id === 2 || r.id === 3) {
                    const secondaries = RELAYS.filter(x => !x.isMaster).map(x => x.path);
                    const allOn = secondaries.every(p => relayStates[p]);
                    if(masterBtn) {
                        if(allOn) {
                            masterBtn.innerText = "APAGAR TODAS";
                            masterBtn.className = "toggle-btn w-full bg-danger hover:bg-red-700 text-white font-bold py-3 lg:py-4 rounded-xl shadow-lg text-base lg:text-lg";
                        } else {
                            masterBtn.innerText = "ENCENDER TODAS";
                            masterBtn.className = "toggle-btn w-full bg-on-green hover:bg-green-600 text-white font-bold py-3 lg:py-4 rounded-xl shadow-lg text-base lg:text-lg";
                        }
                    }
                }
            });
            if(btnEl && !r.isMaster) {
                btnEl.onclick = async () => {
                    const auto = await get(autoRef);
                    if(auto.val()) { displayMessage("¡Desactiva el modo automático para control manual!", 'error'); return; }
                    const newState = !relayStates[r.path];
                    set(rRef, newState).then(() => displayMessage(`${r.name} ${newState ? 'activada' : 'desactivada'}`, 'success'));
                }
            }
        });

        if(masterBtn) {
            masterBtn.onclick = async () => {
                const auto = await get(autoRef);
                if(auto.val()) { displayMessage("¡Desactiva el modo automático para control general!", 'error'); return; }
                const secondaries = RELAYS.filter(x => !x.isMaster);
                const allOn = secondaries.every(x => relayStates[x.path]);
                const target = !allOn;
                confirmTitle.innerText = target ? "Encender Todo" : "Apagar Todo";
                confirmMessage.innerText = target ? "¿Deseas abrir todas las válvulas de riego?" : "¿Deseas cerrar todas las válvulas de riego?";
                showModal('masterConfirmModal');
                confirmActionBtn.onclick = () => {
                    hideModal('masterConfirmModal');
                    secondaries.forEach(x => set(ref(db, "/"+x.path), target));
                    displayMessage(`Acción masiva completada: ${target ? 'ENCENDIDO' : 'APAGADO'}`, 'success');
                };
            }
        }
    }

    function updateRelay4MasterState() {
        const anyOn = [relayStates.relay1, relayStates.relay2, relayStates.relay3].some(x => x);
        if(anyOn !== relayStates.relay4) { set(ref(db, "/relay4"), anyOn); }
    }

    function setupSensorListener(sec, id) {
        const humEl = document.querySelector(`.humedad-value-${id}`);
        const lumEl = document.querySelector(`.luminosity-value-${id}`);
        onValue(ref(db, `/secciones/${sec}/humedad`), s => {
            const val = s.val();
            if(humEl) humEl.innerText = val !== null ? val + " %" : "--";
            if (val !== null && val < 20) {
                const secName = RELAYS.find(r => r.id === id)?.friendlyName || sec;
                checkAndAlert(`low_soil_${sec}`, `¡SUELO SECO en ${secName}! Humedad: ${val}%`, 'error', '¡RIEGO NECESARIO!');
            }
        });
        onValue(ref(db, `/secciones/${sec}/luminosidad`), s => {
            const val = s.val();
            if(lumEl) lumEl.innerText = val !== null ? val + " Lux" : "--";
            if (val !== null) {
                const secName = RELAYS.find(r => r.id === id)?.friendlyName || sec;
                if (sec === 'sombra' && val > 10000) checkAndAlert(`high_light_${sec}`, `¡Exceso de luz en ${secName}! (${val} Lux)`, 'error', '¡DEMASIADA LUZ!');
                else if (sec === 'sol' && val < 5000) checkAndAlert(`low_light_${sec}`, `¡Poca luz en ${secName}! (${val} Lux)`, 'error', '¡FALTA DE LUZ!');
            }
        });
    }

    document.addEventListener("DOMContentLoaded", () => showPage('login'));

    // --- FUNCIONES DE PROGRAMACIÓN DE RIEGO ---
    
    // Convertir formato 12h a 24h
    function convertTo24Hour(hour, minute, period) {
        let hour24 = parseInt(hour);
        if (period === 'PM' && hour24 !== 12) {
            hour24 += 12;
        } else if (period === 'AM' && hour24 === 12) {
            hour24 = 0;
        }
        return `${String(hour24).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
    }
    
    // Convertir formato 24h a 12h
    function convertTo12Hour(time24) {
        const [hour24, min] = time24.split(':').map(Number);
        let hour12 = hour24 % 12;
        if (hour12 === 0) hour12 = 12;
        const period = hour24 >= 12 ? 'PM' : 'AM';
        return { hour: hour12, minute: min, period };
    }
    
    // --- FUNCIONES DE CONFIGURACIÓN DE UMBRALES ---
    
    function openThresholdsModal(sectionId) {
        console.log('Abriendo modal de umbrales para sección:', sectionId);
        currentThresholdSection = sectionId;
        const relay = RELAYS.find(r => r.id === sectionId);
        console.log('Relay encontrado:', relay);
        
        // Guardar el ID en el botón usando data-attribute
        const btn = document.getElementById('saveThresholdsBtn');
        if (btn) btn.setAttribute('data-section', sectionId);
        
        const sectionNameEl = document.getElementById('thresholdSectionName');
        const minEl = document.getElementById('thresholdMin');
        const maxEl = document.getElementById('thresholdMax');
        
        console.log('Elementos encontrados:', {sectionNameEl, minEl, maxEl});
        
        if (sectionNameEl) sectionNameEl.innerText = relay.friendlyName;
        
        // Cargar valores existentes si hay
        const existingThreshold = thresholds[sectionId];
        console.log('Umbrales existentes:', existingThreshold);
        
        if (existingThreshold) {
            if (minEl) minEl.value = existingThreshold.min || '';
            if (maxEl) maxEl.value = existingThreshold.max || '';
        } else {
            if (minEl) minEl.value = '';
            if (maxEl) maxEl.value = '';
        }
        
        console.log('Mostrando modal thresholdsModal');
        showModal('thresholdsModal');
    }
    window.openThresholdsModal = openThresholdsModal;
    
    // Inicializar botón de guardar umbrales - SIMPLIFICADO
    function initializeThresholdsButton() {
        const saveThresholdsBtn = document.getElementById('saveThresholdsBtn');
        console.log('Inicializando botón de umbrales:', saveThresholdsBtn);
        
        if (!saveThresholdsBtn) {
            console.error('No se encontró el botón saveThresholdsBtn');
            return;
        }
        
        // Remover listeners anteriores
        const newBtn = saveThresholdsBtn.cloneNode(true);
        saveThresholdsBtn.parentNode.replaceChild(newBtn, saveThresholdsBtn);
        
        // Agregar el listener al nuevo botón
        newBtn.addEventListener('click', function() {
            console.log('=== CLICK EN GUARDAR UMBRALES ===');
            
            // Obtener valores
            const minVal = document.getElementById('thresholdMin').value;
            const maxVal = document.getElementById('thresholdMax').value;
            const sectionId = parseInt(this.getAttribute('data-section')) || currentThresholdSection;
            
            console.log('Valores a guardar:', {minVal, maxVal, sectionId});
            
            // Validaciones
            if (minVal === '' || maxVal === '') {
                displayMessage('Por favor ingresa ambos valores', 'error');
                return;
            }
            
            const min = parseInt(minVal);
            const max = parseInt(maxVal);
            
            if (isNaN(min) || isNaN(max)) {
                displayMessage('Por favor ingresa valores numéricos válidos', 'error');
                return;
            }
            
            if (min < 0 || min > 100 || max < 0 || max > 100) {
                displayMessage('Los valores deben estar entre 0 y 100', 'error');
                return;
            }
            
            if (min >= max) {
                displayMessage('El umbral mínimo debe ser menor que el máximo', 'error');
                return;
            }
            
            // Obtener la sección correcta
            const relay = RELAYS.find(r => r.id === sectionId);
            if (!relay) {
                displayMessage('Error: no se encontró la sección', 'error');
                return;
            }
            
            const sectionKey = relay.sectionKey;
            console.log('Guardando en Firebase - Sección:', sectionKey);
            
            // Guardar en Firebase
            const minRef = ref(db, `/umbrales/${sectionKey}/min`);
            const maxRef = ref(db, `/umbrales/${sectionKey}/max`);
            
            Promise.all([
                set(minRef, min),
                set(maxRef, max)
            ]).then(() => {
                console.log('✅ Umbrales guardados exitosamente');
                thresholds[sectionId] = { min, max };
                updateThresholdUI(sectionId);
                hideModal('thresholdsModal');
                displayMessage(`Umbrales actualizados: ${min}% - ${max}%`, 'success');
                
                // Limpiar inputs
                document.getElementById('thresholdMin').value = '';
                document.getElementById('thresholdMax').value = '';
            }).catch(err => {
                console.error('❌ Error al guardar umbrales:', err);
                displayMessage('Error al guardar umbrales: ' + err.message, 'error');
            });
        });
        
        console.log('✅ Listener agregado al botón de umbrales');
    }
    
    // Actualizar UI de umbrales
    function updateThresholdUI(sectionId) {
        const infoEl = document.getElementById(`threshold-info-${sectionId}`);
        const valuesEl = document.getElementById(`threshold-values-${sectionId}`);
        
        if (thresholds[sectionId] && thresholds[sectionId].min !== undefined && thresholds[sectionId].max !== undefined) {
            if (infoEl) infoEl.classList.remove('hidden');
            if (valuesEl) {
                valuesEl.innerText = `${thresholds[sectionId].min}% - ${thresholds[sectionId].max}%`;
            }
        } else {
            if (infoEl) infoEl.classList.add('hidden');
        }
    }
    
    // Cargar umbrales desde Firebase
    function loadThresholdsFromFirebase() {
        console.log('Cargando umbrales desde Firebase...');
        [1, 2, 3].forEach(id => {
            const relay = RELAYS.find(r => r.id === id);
            const sectionKey = relay.sectionKey;
            
            console.log(`Cargando umbrales para sección ${id} (${sectionKey})`);
            
            const minRef = ref(db, `/umbrales/${sectionKey}/min`);
            const maxRef = ref(db, `/umbrales/${sectionKey}/max`);
            
            onValue(minRef, (snap) => {
                const minVal = snap.val();
                console.log(`Min para ${sectionKey}:`, minVal);
                if (minVal !== null) {
                    if (!thresholds[id]) thresholds[id] = {};
                    thresholds[id].min = minVal;
                    updateThresholdUI(id);
                }
            });
            
            onValue(maxRef, (snap) => {
                const maxVal = snap.val();
                console.log(`Max para ${sectionKey}:`, maxVal);
                if (maxVal !== null) {
                    if (!thresholds[id]) thresholds[id] = {};
                    thresholds[id].max = maxVal;
                    updateThresholdUI(id);
                }
            });
        });
    }
    
    function openScheduleModal(sectionId) {
        currentScheduleSection = sectionId;
        const relay = RELAYS.find(r => r.id === sectionId);
        const sectionNameEl = document.getElementById('scheduleSectionName');
        const statusTextEl = document.getElementById('scheduleStatusText');
        
        if (sectionNameEl) sectionNameEl.innerText = relay.friendlyName;
        
        // Cargar datos existentes si hay
        const existingSchedule = schedules[sectionId];
        if (existingSchedule) {
            const startTime = convertTo12Hour(existingSchedule.startTime);
            const endTime = convertTo12Hour(existingSchedule.endTime);
            
            document.getElementById('scheduleStartHour').value = startTime.hour;
            document.getElementById('scheduleStartMin').value = String(startTime.minute).padStart(2, '0');
            document.getElementById('scheduleStartPeriod').value = startTime.period;
            
            document.getElementById('scheduleEndHour').value = endTime.hour;
            document.getElementById('scheduleEndMin').value = String(endTime.minute).padStart(2, '0');
            document.getElementById('scheduleEndPeriod').value = endTime.period;
            
            // Marcar frecuencia
            const frequencyRadios = document.getElementsByName('scheduleFrequency');
            frequencyRadios.forEach(radio => {
                radio.checked = (radio.value === existingSchedule.frequency);
            });
            
            statusTextEl.innerText = 'Programado';
            statusTextEl.className = 'text-sm font-bold text-primary-green';
        } else {
            document.getElementById('scheduleStartHour').value = '';
            document.getElementById('scheduleStartMin').value = '';
            document.getElementById('scheduleStartPeriod').value = 'AM';
            document.getElementById('scheduleEndHour').value = '';
            document.getElementById('scheduleEndMin').value = '';
            document.getElementById('scheduleEndPeriod').value = 'AM';
            
            const frequencyRadios = document.getElementsByName('scheduleFrequency');
            frequencyRadios[0].checked = true; // "Una vez" por defecto
            
            statusTextEl.innerText = 'Sin programar';
            statusTextEl.className = 'text-sm font-bold text-gray-500';
        }
        
        showModal('scheduleModal');
    }
    window.openScheduleModal = openScheduleModal;
    
    // Guardar programación
    const saveScheduleBtn = document.getElementById('saveScheduleBtn');
    if (saveScheduleBtn) {
        saveScheduleBtn.onclick = () => {
            const startHour = document.getElementById('scheduleStartHour').value;
            const startMin = document.getElementById('scheduleStartMin').value;
            const startPeriod = document.getElementById('scheduleStartPeriod').value;
            
            const endHour = document.getElementById('scheduleEndHour').value;
            const endMin = document.getElementById('scheduleEndMin').value;
            const endPeriod = document.getElementById('scheduleEndPeriod').value;
            
            const frequency = document.querySelector('input[name="scheduleFrequency"]:checked').value;
            
            if (!startHour || !startMin || !endHour || !endMin) {
                displayMessage('Por favor completa todos los campos de hora', 'error');
                return;
            }
            
            if (parseInt(startHour) < 1 || parseInt(startHour) > 12) {
                displayMessage('La hora debe estar entre 1 y 12', 'error');
                return;
            }
            
            if (parseInt(startMin) < 0 || parseInt(startMin) > 59 || parseInt(endMin) < 0 || parseInt(endMin) > 59) {
                displayMessage('Los minutos deben estar entre 0 y 59', 'error');
                return;
            }
            
            const startTime24 = convertTo24Hour(startHour, startMin, startPeriod);
            const endTime24 = convertTo24Hour(endHour, endMin, endPeriod);
            
            if (startTime24 >= endTime24) {
                displayMessage('La hora de inicio debe ser anterior a la hora de fin', 'error');
                return;
            }
            
            schedules[currentScheduleSection] = {
                startTime: startTime24,
                endTime: endTime24,
                frequency: frequency,
                active: true,
                activated: false,
                confirmationShown: false
            };
            
            // Guardar en Firebase
            const scheduleRef = ref(db, `/schedules/section${currentScheduleSection}`);
            set(scheduleRef, schedules[currentScheduleSection]).then(() => {
                updateScheduleUI(currentScheduleSection);
                hideModal('scheduleModal');
                const freqText = frequency === 'daily' ? 'todos los días' : 'una sola vez';
                displayMessage(`Riego programado para ${RELAYS.find(r => r.id === currentScheduleSection).friendlyName} (${freqText})`, 'success');
            });
        };
    }
    
    // Cancelar programación
    const cancelScheduleBtn = document.getElementById('cancelScheduleBtn');
    if (cancelScheduleBtn) {
        cancelScheduleBtn.onclick = () => {
            if (!schedules[currentScheduleSection]) {
                displayMessage('No hay programación activa para cancelar', 'info');
                return;
            }
            
            schedules[currentScheduleSection] = null;
            const scheduleRef = ref(db, `/schedules/section${currentScheduleSection}`);
            set(scheduleRef, null).then(() => {
                updateScheduleUI(currentScheduleSection);
                hideModal('scheduleModal');
                displayMessage('Programación cancelada', 'info');
            });
        };
    }
    
    // Actualizar UI de programación
    function updateScheduleUI(sectionId) {
        const infoEl = document.getElementById(`schedule-info-${sectionId}`);
        const timeEl = document.getElementById(`schedule-time-${sectionId}`);
        
        if (schedules[sectionId]) {
            const start = convertTo12Hour(schedules[sectionId].startTime);
            const end = convertTo12Hour(schedules[sectionId].endTime);
            const freqIcon = schedules[sectionId].frequency === 'daily' ? '🔄' : '1️⃣';
            
            if (infoEl) infoEl.classList.remove('hidden');
            if (timeEl) {
                timeEl.innerText = `${freqIcon} ${start.hour}:${String(start.minute).padStart(2, '0')} ${start.period} - ${end.hour}:${String(end.minute).padStart(2, '0')} ${end.period}`;
            }
        } else {
            if (infoEl) infoEl.classList.add('hidden');
        }
    }
    
    // Cargar programaciones desde Firebase
    function loadSchedulesFromFirebase() {
        [1, 2, 3].forEach(id => {
            const scheduleRef = ref(db, `/schedules/section${id}`);
            onValue(scheduleRef, (snap) => {
                const data = snap.val();
                schedules[id] = data;
                updateScheduleUI(id);
            });
        });
    }
    
    // Monitorear programaciones
    function startScheduleMonitoring() {
        scheduleCheckInterval = setInterval(() => {
            checkSchedules();
        }, 10000); // Revisar cada 10 segundos para mayor precisión
    }
    
    function checkSchedules() {
        // Obtener hora de Colombia (UTC-5)
        const now = new Date();
        const colombiaTime = new Date(now.toLocaleString("en-US", {timeZone: "America/Bogota"}));
        const currentTime = `${String(colombiaTime.getHours()).padStart(2, '0')}:${String(colombiaTime.getMinutes()).padStart(2, '0')}`;
        
        console.log('Verificando programaciones - Hora Colombia:', currentTime);
        
        [1, 2, 3].forEach(sectionId => {
            const schedule = schedules[sectionId];
            if (!schedule || !schedule.active) return;
            
            console.log(`Sección ${sectionId} - Programado: ${schedule.startTime} - ${schedule.endTime}`);
            
            // Verificar si estamos 1 minuto antes del inicio
            const [startHour, startMin] = schedule.startTime.split(':').map(Number);
            const scheduledTime = new Date(colombiaTime);
            scheduledTime.setHours(startHour, startMin, 0, 0);
            
            const timeDiff = scheduledTime.getTime() - colombiaTime.getTime();
            
            // Si falta exactamente 1 minuto (con margen de 15 seg)
            if (timeDiff > 45000 && timeDiff <= 75000 && !schedule.confirmationShown) {
                console.log(`Mostrando confirmación para sección ${sectionId}`);
                schedule.confirmationShown = true;
                showScheduleConfirmation(sectionId, schedule);
            }
            
            // Verificar si es hora de ACTIVAR (cuando llega la hora exacta)
            if (currentTime === schedule.startTime && !schedule.activated) {
                console.log(`Activando riego en sección ${sectionId}`);
                schedule.activated = true;
                
                // Actualizar en Firebase para mantener estado
                const scheduleRef = ref(db, `/schedules/section${sectionId}`);
                set(scheduleRef, schedule);
                
                activateScheduledIrrigation(sectionId);
            }
            
            // Verificar si es hora de desactivar
            if (currentTime >= schedule.endTime && schedule.activated) {
                const relay = RELAYS.find(r => r.id === sectionId);
                if (relayStates[relay.path]) {
                    console.log(`Desactivando riego en sección ${sectionId}`);
                    set(ref(db, "/" + relay.path), false);
                    displayMessage(`Riego finalizado en ${relay.friendlyName}`, 'info');
                    
                    // Si es "una vez", desactivar la programación
                    if (schedule.frequency === 'once') {
                        schedules[sectionId] = null;
                        const scheduleRef = ref(db, `/schedules/section${sectionId}`);
                        set(scheduleRef, null);
                        updateScheduleUI(sectionId);
                        displayMessage(`Programación única completada en ${relay.friendlyName}`, 'info');
                    } else {
                        // Si es diaria, resetear para el próximo día
                        schedule.activated = false;
                        schedule.confirmationShown = false;
                        const scheduleRef = ref(db, `/schedules/section${sectionId}`);
                        set(scheduleRef, schedule);
                    }
                }
            }
        });
    }
    
    // Mostrar confirmación 1 minuto antes
    function showScheduleConfirmation(sectionId, schedule) {
        const relay = RELAYS.find(r => r.id === sectionId);
        const messageEl = document.getElementById('scheduleConfirmMessage');
        const modal = document.getElementById('scheduleConfirmModal');
        
        if (messageEl) {
            messageEl.innerHTML = `El riego se activará en <strong>${relay.friendlyName}</strong> en 1 minuto`;
        }
        
        showModal('scheduleConfirmModal');
        
        // Contador regresivo
        let countdown = 60;
        const timerEl = document.getElementById('countdownTimer');
        
        if (countdownInterval) clearInterval(countdownInterval);
        
        countdownInterval = setInterval(() => {
            countdown--;
            if (timerEl) timerEl.innerText = `${countdown}s`;
            
            if (countdown <= 0) {
                clearInterval(countdownInterval);
                hideModal('scheduleConfirmModal');
                // NO activar aquí, esperar a que checkSchedules lo haga cuando llegue la hora exacta
            }
        }, 1000);
        
        // Botón de cancelar
        const cancelBtn = document.getElementById('cancelScheduledIrrigationBtn');
        if (cancelBtn) {
            cancelBtn.onclick = () => {
                clearInterval(countdownInterval);
                hideModal('scheduleConfirmModal');
                displayMessage('Activación de riego cancelada', 'info');
                // Desactivar la programación para hoy
                schedule.activated = true; // Marcar como activado para que no se ejecute
            };
        }
    }
    
    // Activar riego programado
    function activateScheduledIrrigation(sectionId) {
        const relay = RELAYS.find(r => r.id === sectionId);
        const schedule = schedules[sectionId];
        
        if (!schedule) return;
        
        // Activar válvula
        set(ref(db, "/" + relay.path), true).then(() => {
            displayMessage(`¡Riego activado en ${relay.friendlyName}!`, 'success');
            
            // Notificación del sistema
            if ("Notification" in window && Notification.permission === "granted") {
                new Notification("Riego Programado Activado", {
                    body: `Se ha iniciado el riego en ${relay.friendlyName}`,
                    icon: 'https://cdn-icons-png.flaticon.com/512/3050/3050158.png'
                });
            }
        });
    }

</script>
</body>
</html>